<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMD Maharashtra - Meteorological Monitoring</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}?v=3">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/d3_map.css') }}?v=3">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/notam_styles.css') }}?v=3">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/d3.v7.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/topojson.min.js') }}"></script>
</head>

<body>
    {% include 'includes/header.html' %}
    {% include 'includes/navbar.html' %}

    <!-- NOTAM Upload Modal -->
    <div id="notamModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('notamModal')">&times;</span>
            <h3>Upload NOTAM PDF</h3>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                Upload a NOTAM .pdf file. Text will be extracted automatically.
            </p>
            <form id="notam-upload-form" onsubmit="handleNotamUpload(event)">
                <input type="file" name="file" accept=".pdf" required class="modal-input">
                <button type="submit" class="modal-submit-btn">Upload & Parse</button>
            </form>
            <div id="notam-status" style="margin-top:10px; font-size: 0.9rem;"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Left Sidebar -->
        <aside class="sidebar left-sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    OPERATIONAL ACTIONS
                    {% if session.get('role') == 'admin' %}
                    <span class="sidebar-add-btn" onclick="openAddButtonModal('operational')">+</span>
                    <span class="sidebar-add-btn" onclick="openDeleteButtonModal('operational')"
                        style="background:#dc3545; margin-right:5px; padding:2px 8px;" title="Delete Button">-</span>
                    {% endif %}
                </h3>




                <a href="https://121.240.10.8:8000" target="_blank" rel="noopener noreferrer"
                    class="action-btn warning-btn"
                    style="text-decoration:none; text-align:center; display:block; padding-top:10px;">Aerodrome ‚Üó</a>

                <!-- NOTAM Module -->
                <div class="notam-module" id="notam-module">
                    <div class="notam-header">NOTAM</div>

                    <!-- Admin Controls -->
                    {% if session.get('role') == 'admin' %}
                    <div class="notam-admin-panel">
                        <!-- Tabs -->
                        <div class="notam-tabs">
                            <button class="tab-btn active" onclick="switchNotamTab('active')">Active</button>
                            <button class="tab-btn" onclick="switchNotamTab('drafts')">Drafts</button>
                            <button class="tab-btn" onclick="switchNotamTab('archived')">Archived</button>
                        </div>

                        <!-- VIEW: ACTIVE -->
                        <div id="notam-view-active" class="notam-tab-content">
                            <div id="admin-active-list"></div>
                        </div>

                        <!-- VIEW: DRAFTS -->
                        <div id="notam-view-drafts" class="notam-tab-content" style="display:none;">
                            <!-- Upload Button -->
                            <form id="notam-upload-form" style="margin-bottom:10px; text-align:center;">
                                <input type="file" name="file" id="notam-file-in" accept=".pdf" style="display: none;"
                                    onchange="uploadNotamDraft(this)">
                                <button type="button" class="notam-action-btn"
                                    onclick="document.getElementById('notam-file-in').click()">
                                    Upload New PDF
                                </button>
                            </form>
                            <div id="admin-draft-list"></div>
                        </div>

                        <!-- VIEW: ARCHIVED -->
                        <div id="notam-view-archived" class="notam-tab-content" style="display:none;">
                            <div id="admin-archived-list"></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Public Ticker Display -->
                    <div class="notam-ticker-container" id="notam-ticker" style="display: none;">
                        <div class="notam-ticker-wrap">
                            <div class="notam-ticker-item" id="notam-text"></div>
                        </div>
                    </div>
                </div>

                {% if dynamic_buttons and dynamic_buttons['operational'] %}
                {% for btn in dynamic_buttons['operational'] %}
                <div style="position:relative;">
                    <a href="{{ btn.url if btn.type == 'link' else url_for('map.serve_file', type='misc', filename=btn.file_path) }}"
                        target="_blank" class="action-btn" style="margin-top:5px; display:block; text-decoration:none;">
                        {{ btn.label }}
                    </a>
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    EXTERNAL TOOLS
                    {% if session.get('role') == 'admin' %}
                    <span class="sidebar-add-btn" onclick="openAddButtonModal('external')">+</span>
                    <span class="sidebar-add-btn" onclick="openDeleteButtonModal('external')"
                        style="background:#dc3545; margin-right:5px; padding:2px 8px;" title="Delete Button">-</span>
                    {% endif %}
                </h3>
                <a href="https://camd.imd.gov.in/dgca-cp/" target="_blank" class="sidebar-btn">Instrument
                    Calibration</a>
                <a href="http://121.240.10.9:8080/" target="_blank" class="sidebar-btn">Forecast Verification</a>
                <button class="sidebar-btn disabled">Automatic TAF</button>

                {% if dynamic_buttons and dynamic_buttons['external'] %}
                {% for btn in dynamic_buttons['external'] %}
                <div style="position:relative;">
                    <a href="{{ btn.url if btn.type == 'link' else url_for('map.serve_file', type='misc', filename=btn.file_path) }}"
                        target="_blank" class="sidebar-btn">
                        {{ btn.label }}
                    </a>
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <!-- News & Events (Official) -->
            <div class="sidebar-section news-sidebar-section">
                <h3 class="sidebar-title board-header-sidebar">
                    üì¢ News & Events
                    {% if session.get('role') == 'admin' %}
                    <span class="sidebar-add-btn" onclick="openModal('newsModal')">+</span>
                    {% endif %}
                </h3>

                <div class="sidebar-content-scroll">
                    {% if news_items %}
                    {% for item in news_items %}
                    {% if item.status == 'DRAFT' %}
                    <!-- Draft News -->
                    <div class="sidebar-item" style="border-left: 3px solid orange; background: #fffbe6;">
                        <div class="sidebar-item-header">
                            <span class="item-user">üìù Draft</span>
                            <span class="item-date">{{ item.upload_time }}</span>
                        </div>
                        {% if item.filename %}
                        {% set ext = item.filename.split('.')[-1].lower() %}
                        {% if ext in ['png', 'jpg', 'jpeg', 'gif', 'webp'] %}
                        <img src="{{ url_for('map.serve_file', type='news', filename=item.filename) }}"
                            style="width:100%; max-height:150px; object-fit:contain; margin:5px 0; border:1px solid #ddd;"
                            alt="News Image" onclick="window.open(this.src, '_blank')" style="cursor:pointer;">
                        {% else %}
                        <div style="margin:5px 0;">
                            <a href="{{ url_for('map.serve_file', type='news', filename=item.filename) }}"
                                target="_blank" class="sidebar-attachment-link"
                                style="display:block; padding:5px; background:#f0f0f0; border-radius:4px; text-decoration:none; color:#333;">
                                üìÑ {{ item.filename }} üìé
                            </a>
                        </div>
                        {% endif %}
                        {% endif %}

                        <input type="text" id="news-title-{{item.id}}" value="{{ item.title }}" class="notam-edit-area"
                            style="height:30px; margin-bottom:5px; font-weight:bold;">
                        <textarea id="news-desc-{{item.id}}" class="notam-edit-area"
                            style="height:60px;">{{ item.description }}</textarea>

                        <div style="margin-top:5px; text-align:right;">
                            <button onclick="publishNews({{ item.id }})" class="btn-xs btn-publish">Publish</button>
                            <button onclick="deleteNews({{ item.id }})" class="btn-xs btn-danger">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <!-- Published News -->
                    <div class="sidebar-item">
                        <div class="sidebar-item-header">
                            <span class="item-date">{{ item.upload_time }}</span>
                            {% if session.get('role') == 'admin' %}
                            <button class="sidebar-delete-btn" onclick="deleteNews({{ item.id }})"
                                style="border:none; background:none; cursor:pointer; color:red;">√ó</button>
                            {% endif %}
                        </div>

                        {% set has_file = item.filename is not none %}
                        {% set ext = item.filename.split('.')[-1].lower() if has_file else '' %}
                        {% set is_image = ext in ['png', 'jpg', 'jpeg', 'gif', 'webp'] %}

                        {% if has_file and not is_image %}
                        <a href="{{ url_for('map.serve_file', type='news', filename=item.filename) }}" target="_blank"
                            class="sidebar-item-title-link">
                            {{ item.title }} üìé
                        </a>
                        {% else %}
                        <div class="sidebar-item-title">{{ item.title }}</div>
                        {% endif %}

                        {% if item.description %}
                        <div class="sidebar-item-desc">{{ item.description }}</div>
                        {% endif %}

                        {% if has_file and is_image %}
                        <img src="{{ url_for('map.serve_file', type='news', filename=item.filename) }}"
                            style="width:100%; max-height:150px; object-fit:contain; margin:5px 0; border-radius:4px; cursor:pointer;"
                            onclick="window.open(this.src, '_blank')">
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="empty-sidebar-msg">No active news.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Notice Board (Internal) -->
            <div class="sidebar-section notice-sidebar-section">
                <h3 class="sidebar-title board-header-sidebar">
                    üìå Notice Board
                    {% if session.get('user') %}
                    <span class="sidebar-add-btn" onclick="openModal('noticeModal')">+</span>
                    {% endif %}
                </h3>
                <div class="sidebar-content-scroll">
                    {% if notice_items %}
                    {% for item in notice_items %}
                    {% if item.status == 'DRAFT' %}
                    <!-- Draft Notice -->
                    <div class="sidebar-item" style="border-left: 3px solid orange; background: #fffbe6;">
                        <div class="sidebar-item-header">
                            <span class="item-user">üìù Draft</span>
                            <span class="item-date">{{ item.upload_time }}</span>
                        </div>
                        {% if item.filename %}
                        <img src="{{ url_for('map.serve_file', type='notices', filename=item.filename) }}"
                            style="width:100%; max-height:150px; object-fit:contain; margin:5px 0; border:1px solid #ddd;">
                        {% endif %}

                        <input type="text" id="notice-title-{{item.id}}" value="Notice" class="notam-edit-area"
                            style="height:30px; margin-bottom:5px; font-weight:bold;">
                        <textarea id="notice-msg-{{item.id}}" class="notam-edit-area"
                            style="height:60px;">{{ item.message }}</textarea>

                        <div style="margin-top:5px; text-align:right;">
                            <button onclick="publishNotice({{ item.id }})" class="btn-xs btn-publish">Publish</button>
                            <button onclick="deleteNotice({{ item.id }})" class="btn-xs btn-danger">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <!-- Published Notice -->
                    <div class="sidebar-item">
                        <div class="sidebar-item-header">
                            <span class="item-user">üë§ {{ item.uploaded_by }}</span>
                            <span class="item-date">{{ item.upload_time }}</span>
                        </div>
                        <div class="sidebar-item-title">{{ item.title }}</div>

                        <!-- Image Display -->
                        {% if item.filename and item.filename.lower().endswith(('.png', '.jpg', '.jpeg')) %}
                        <img src="{{ url_for('map.serve_file', type='notices', filename=item.filename) }}"
                            style="width:100%; max-height:200px; object-fit:contain; margin:5px 0; border-radius:4px;">
                        {% endif %}

                        <div class="sidebar-item-desc">{{ item.message }}</div>

                        {% if item.filename and not item.filename.lower().endswith(('.png', '.jpg', '.jpeg')) %}
                        <a href="{{ url_for('map.serve_file', type='notices', filename=item.filename) }}"
                            target="_blank" class="sidebar-attachment-link">
                            üìé Attachment
                        </a>
                        {% endif %}

                        <div style="font-size: 0.7rem; color:#888; margin-top:3px;">
                            {{ item.upload_time }}
                            {% if session.get('role') == 'admin' %}
                            <span style="float:right; cursor:pointer; color:red;"
                                onclick="deleteNotice({{ item.id }})">üóëÔ∏è</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="empty-sidebar-msg">No notices.</div>
                    {% endif %}
                </div>
            </div>
        </aside>

        <!-- Center Map Panel -->
        <div class="center-panel">
            <div class="map-wrapper">
                <div class="d3-map-scoped" id="map-viewport">
                    <svg id="d3-map-svg"></svg>

                    <!-- Map Controls -->
                    <div id="map-controls">
                        <button class="map-btn" id="zoom-in">+</button>
                        <button class="map-btn" id="zoom-out">-</button>
                        <button class="map-btn" id="zoom-reset">RESET</button>
                    </div>

                    <!-- Scale Bar -->
                    <div id="scale-bar-container">
                        <div id="scale-bar-line"></div>
                        <div id="scale-bar-text">500 km</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <aside class="sidebar right-sidebar">
            <!-- OLBS Section -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    OLBS
                    {% if session.get('role') == 'admin' %}
                    <span class="sidebar-add-btn" onclick="openAddButtonModal('olbs')">+</span>
                    <span class="sidebar-add-btn" onclick="openDeleteButtonModal('olbs')"
                        style="background:#dc3545; margin-right:5px; padding:2px 8px;" title="Delete Button">-</span>
                    {% endif %}
                </h3>
                <div class="olbs-container">
                    <a href="https://olbs.amsschennai.gov.in/nsweb/FlightBriefing/#showLogin" target="_blank"
                        class="olbs-btn">Chennai</a>
                    <a href="https://olbs.amssdelhi.gov.in/nsweb/FlightBriefing/#showLogin" target="_blank"
                        class="olbs-btn">Delhi</a>

                    {% if dynamic_buttons and dynamic_buttons['olbs'] %}
                    {% for btn in dynamic_buttons['olbs'] %}
                    <div style="position:relative;">
                        <a href="{{ btn.url if btn.type == 'link' else url_for('map.serve_file', type='misc', filename=btn.file_path) }}"
                            target="_blank" class="olbs-btn">
                            {{ btn.label }}
                        </a>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    RESOURCES
                    {% if session.get('role') == 'admin' %}
                    <span class="sidebar-add-btn" onclick="openAddButtonModal('resources')">+</span>
                    <span class="sidebar-add-btn" onclick="openDeleteButtonModal('resources')"
                        style="background:#dc3545; margin-right:5px; padding:2px 8px;" title="Delete Button">-</span>
                    {% endif %}
                </h3>
                <a href="https://mausam.imd.gov.in/mumbai/" target="_blank" class="sidebar-link">RMC Mumbai</a>
                <a href="https://satmet.imd.gov.in/" target="_blank" class="sidebar-link">Satellite Images</a>
                <a href="https://metnet.imd.gov.in/Welcome_to_Intra-IMD/welcome.php" target="_blank"
                    class="sidebar-link">METNET</a>
                <a href="https://internal.imd.gov.in/pages/radar_main.php?adta=vrv" target="_blank"
                    class="sidebar-link">Radar / DWR</a>

                {% if dynamic_buttons and dynamic_buttons['resources'] %}
                {% for btn in dynamic_buttons['resources'] %}
                <div style="position:relative;">
                    <a href="{{ btn.url if btn.type == 'link' else url_for('map.serve_file', type='misc', filename=btn.file_path) }}"
                        target="_blank" class="sidebar-link">
                        {{ btn.label }}
                    </a>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- Bottom Info Panel -->
    <div class="bottom-info-container">
        <div class="info-card rvr-card bottom-card">
            <div class="card-header">
                LIVE RVR ‚Äì MUMBAI
            </div>
            <div class="card-content rvr-content-compact" id="rvr-container"
                style="padding: 0; overflow: hidden; background-color: #000; display: flex; align-items: center; justify-content: center;">
                <img id="rvr-screenshot" src="{{ url_for('static', filename='rvr/latest_rvr.png') }}"
                    alt="RVR Status - Loading..."
                    style="width: 100%; height: auto; object-fit: contain; max-height: 100%;"
                    onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/rvr_placeholder.png') }}'; this.alt='RVR Unavailable';">

                <script>
                    (function () {
                        const img = document.getElementById('rvr-screenshot');
                        function refreshImage() {
                            const timestamp = new Date().getTime();
                            // Append timestamp to bust cache
                            const baseUrl = "{{ url_for('static', filename='rvr/latest_rvr.png') }}";
                            img.src = `${baseUrl}?t=${timestamp}`;
                        }
                        // Refresh every 60 seconds
                        setInterval(refreshImage, 60000);
                    })();
                </script>
            </div>
            <div class="info-card bottom-card">
                <div class="card-header">Latest METAR & TAF (VABB)</div>
                <div class="card-content">
                    <div class="metar-display">
                        <p><strong>METAR:</strong> Loading...</p>
                        <p><strong>TAF:</strong> Loading...</p>
                    </div>
                </div>
            </div>
            <div class="info-card bottom-card" id="sigmet-card">
                <div class="card-header">
                    SIGMET ‚Äì Mumbai FIR
                </div>
                <div class="card-content" id="sigmet-content"
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 10px;">
                    <!-- Content will be injected by JS -->
                    <p style="color: #666; font-size: 0.9rem;">Loading status...</p>

                    <a href="https://aviationweather.gov/gfa/#sigmet" target="_blank" class="view-data-btn"
                        style="padding: 8px 20px; font-size: 0.95rem; margin-top: 5px;">
                        Display SIGMET ‚Üó
                    </a>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h3 style="margin-bottom:15px; color:#333;">Internal Login</h3>
            <form action="{{ url_for('map.login') }}" method="POST" class="modal-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required placeholder="User or Admin">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" placeholder="Any password (dev mode)"
                        id="login-password-input">
                </div>
                <div id="login-error-msg"
                    style="color: #d9534f; font-size: 0.9rem; margin-bottom: 10px; display: none; text-align: center;">
                </div>
                <button type="submit" class="submit-btn" id="login-submit-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- News Modal -->
    <div id="newsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('newsModal')">&times;</span>
            <h3 style="margin-bottom:15px; color:#333;">Post News (Admin)</h3>
            <form onsubmit="handleUpload(event, '/api/news/upload')" class="modal-form">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Attachment (Image or Document)</label>
                    <input type="file" name="file">
                </div>
                <button type="submit" class="submit-btn" id="news-submit-btn">Upload News</button>
            </form>
        </div>
    </div>


    <!-- Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('noticeModal')">&times;</span>
            <h3 style="margin-bottom:15px; color:#333;">Post Notice</h3>
            <form onsubmit="handleUpload(event, '/api/notices/post')" class="modal-form">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea name="message" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Attachment (Image or Document)</label>
                    <input type="file" name="file">
                </div>
                <button type="submit" class="submit-btn" id="notice-submit-btn">Post Notice</button>
            </form>
        </div>
    </div>

    <!-- Add Dynamic Button Modal -->
    <div id="addButtonModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addButtonModal')">&times;</span>
            <h3 style="margin-bottom:15px; color:#007bff;">Add Sidebar Button</h3>

            <form id="add-button-form" onsubmit="submitAddButton(event)">
                <input type="hidden" id="btn-section" name="section">

                <div class="form-group">
                    <label>Button Name</label>
                    <input type="text" name="label" required placeholder="e.g. New Link">
                </div>

                <div class="form-group">
                    <label>Button Type</label>
                    <select name="type" id="btn-type-select" onchange="toggleBtnInputs()"
                        style="width:100%; padding:8px;">
                        <option value="link">Hyperlink</option>
                        <option value="file">File Upload (PDF/Image)</option>
                    </select>
                </div>

                <div class="form-group" id="btn-url-group">
                    <label>URL / Link</label>
                    <input type="url" name="url" placeholder="https://example.com" id="btn-url-input">
                </div>

                <div class="form-group" id="btn-file-group" style="display:none;">
                    <label>Upload File</label>
                    <input type="file" name="file" id="btn-file-input">
                </div>

                <button type="submit" class="submit-btn" style="background:#007bff;">Add Button</button>
            </form>
        </div>
    </div>

    <!-- Delete Button Modal -->
    <div id="deleteButtonModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('deleteButtonModal')">&times;</span>
            <h3 style="margin-bottom:15px; color:#dc3545;">Delete Sidebar Button</h3>

            <form id="delete-button-form" onsubmit="submitDeleteButton(event)">
                <input type="hidden" id="del-btn-section" name="section">

                <div class="form-group">
                    <label>Select Button to Delete</label>
                    <select name="btn_id" id="delete-btn-select" class="form-control" style="width:100%; padding:8px;">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="form-group">
                    <p style="font-size:0.9rem; color:#666;">
                        Are you sure? This will remove the button and any associated file.
                    </p>
                </div>

                <button type="submit" class="submit-btn" style="background:#dc3545;">Delete Button</button>
            </form>
        </div>
    </div>

    <footer class="map-footer">
        <p>Data Source: NOAA Aviation Weather Center | Displaying previous 3 complete days (UTC)</p>
    </footer>

    <!-- D3 Map Data Injection -->
    <script>
        // Inject Flask data for D3 map adapter
        window.IMD_STATION_COORDS = {{ station_coords | tojson }};
        window.IMD_STATION_NAMES = {{ stations | tojson }};
        window.IMD_GEOJSON_URL = "{{ url_for('static', filename='geojson/india_state.geojson') }}";
    </script>

    <!-- D3 Map Scripts -->
    <script src="{{ url_for('static', filename='js/d3_map_core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/d3_map_adapter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/clock.js') }}"></script>

    <script>
        // --- NOTICE MANAGEMENT ---
        async function deleteNotice(id) {
            if (!confirm("Are you sure you want to delete this notice?")) return;

            try {
                const response = await fetch(`/api/notices/delete/${id}`, { method: 'POST' });
                if (response.ok) {
                    location.reload(); // Simple reload to refresh list
                } else {
                    alert("Failed to delete notice.");
                }
            } catch (err) {
                console.error("Delete Error:", err);
            }
        }

        async function uploadDraft(type, input) {
            if (!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch(`/api/${type}/draft`, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    location.reload();
                } else {
                    alert('Upload Failed: ' + (data.error || 'Unknown'));
                }
            } catch (e) {
                alert('System Error during upload');
                console.error(e);
            } finally {
                input.value = '';
            }
        }

        async function publishNews(id) {
            const title = document.getElementById(`news-title-${id}`).value;
            const description = document.getElementById(`news-desc-${id}`).value;

            await fetch(`/api/news/publish/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description })
            });
            location.reload();
        }

        async function publishNotice(id) {
            const title = document.getElementById(`notice-title-${id}`).value;
            const message = document.getElementById(`notice-msg-${id}`).value;

            await fetch(`/api/notices/publish/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, message })
            });
            location.reload();
        }

        async function deleteNews(id) {
            if (!confirm("Are you sure you want to delete this news item?")) return;
            try {
                const response = await fetch(`/api/news/delete/${id}`, { method: 'POST' });
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Failed to delete news.");
                }
            } catch (err) {
                console.error("Delete Error:", err);
            }
        }

        // --- NOTAM LIFECYCLE MANAGEMENT ---

        // Tab Switcher
        function switchNotamTab(tabName) {
            // Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Content
            document.querySelectorAll('.notam-tab-content').forEach(div => div.style.display = 'none');
            document.getElementById('notam-view-' + tabName).style.display = 'block';

            // Refresh List
            fetchNotamLists();
        }

        async function fetchNotamLists() {
            try {
                const response = await fetch('/api/notam/list');
                const data = await response.json();

                renderDrafts(data.drafts);
                renderActive(data.active);
                renderArchived(data.archived);

            } catch (err) {
                console.error("Error fetching lists", err);
            }
        }

        function renderDrafts(drafts) {
            const container = document.getElementById('admin-draft-list');
            if (drafts.length === 0) {
                container.innerHTML = '<small style="color:#777">No drafts.</small>';
                return;
            }
            container.innerHTML = drafts.map(n => `
                <div class="notam-card-draft">
                    <textarea id="edit-draft-${n.id}" class="notam-edit-area">${n.final_notam_text}</textarea>
                    <div style="margin-top:5px; font-size:0.75rem;">
                        <span>Valid till: ${n.valid_till_utc} (UTC)</span>
                    </div>
                    <div class="notam-actions">
                        <button onclick="saveDraft(${n.id})" class="btn-xs">Save</button>
                        <button onclick="publishNotam(${n.id})" class="btn-xs btn-publish">Publish</button>
                        <button onclick="deleteNotam(${n.id})" class="btn-xs btn-danger">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderActive(active) {
            const container = document.getElementById('admin-active-list');
            if (active.length === 0) {
                container.innerHTML = '<small style="color:#777">No active NOTAMs.</small>';
                return;
            }
            container.innerHTML = active.map(n => `
                <div class="notam-card-active">
                    <div class="notam-text-display">${n.final_notam_text}</div>
                    <div style="font-size:0.75rem; color:#555;">Expiring: ${n.valid_till_utc}</div>
                     <button onclick="archiveNotam(${n.id})" class="btn-xs btn-warning">Archive</button>
                </div>
            `).join('');
        }

        function renderArchived(archived) {
            const container = document.getElementById('admin-archived-list');
            if (archived.length === 0) {
                container.innerHTML = '<small style="color:#777">No archived NOTAMs.</small>';
                return;
            }
            container.innerHTML = archived.map(n => `
                <div class="notam-card-archived">
                     <div style="font-size:0.8rem; color:#666;">${n.final_notam_text}</div>
                    <button onclick="deleteNotam(${n.id})" class="btn-xs btn-danger" style="margin-top:5px;">Delete Permanent</button>
                </div>
            `).join('');
        }

        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            // Assuming dateStr is "YYYY-MM-DD HH:MM:SS" from DB
            return dateStr.replace(' ', 'T').substring(0, 16);
        }

        function renderDrafts(drafts) {
            const container = document.getElementById('admin-draft-list');
            if (drafts.length === 0) {
                container.innerHTML = '<small style="color:#777">No drafts.</small>';
                return;
            }
            container.innerHTML = drafts.map(n => `
                <div class="notam-card-draft">
                    <label style="font-size:0.75rem; color:#555;">Text Content (Running Line)</label>
                    <textarea id="edit-draft-${n.id}" class="notam-edit-area">${n.final_notam_text}</textarea>
                    
                    <div style="margin-top:5px; font-size:0.75rem;">
                         <label>Expires (UTC):</label>
                         <input type="datetime-local" id="edit-date-${n.id}" value="${formatDateForInput(n.valid_till_utc)}" 
                                style="border:1px solid #ccc; padding:2px; font-size:0.8rem;">
                    </div>
                    
                    <div class="notam-actions">
                        <button onclick="saveDraft(${n.id})" class="btn-xs">Save Changes</button>
                        <button onclick="publishNotam(${n.id})" class="btn-xs btn-publish">Publish</button>
                        <button onclick="deleteNotam(${n.id})" class="btn-xs btn-danger">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Actions
        async function uploadNotamDraft(input) {
            if (!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch('/api/notam/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    alert('Draft Created!');
                    fetchNotamLists();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) { alert('Upload error'); }
            input.value = '';
        }

        async function saveDraft(id) {
            const text = document.getElementById(`edit-draft-${id}`).value;
            const validTill = document.getElementById(`edit-date-${id}`).value;

            // Convert 'T' back to space for DB
            const formattedDate = validTill.replace('T', ' ') + ':00';

            await fetch(`/api/notam/edit/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, valid_till: formattedDate })
            });
            alert('Saved!');
            fetchNotamLists();
        }

        async function publishNotam(id) {
            if (!confirm('Publish this NOTAM? It will go live immediately.')) return;
            await fetch(`/api/notam/publish/${id}`, { method: 'POST' });
            fetchNotamLists();
            fetchActiveNotam(); // Update public view
        }

        async function archiveNotam(id) {
            if (!confirm('Archive this NOTAM? It will be removed from public view.')) return;
            await fetch(`/api/notam/archive/${id}`, { method: 'POST' });
            fetchNotamLists();
            fetchActiveNotam();
        }

        async function deleteNotam(id) {
            if (!confirm('Permanently delete?')) return;
            await fetch(`/api/notam/delete/${id}`, { method: 'POST' });
            fetchNotamLists();
        }

        // Initial Load for admin
        {% if session.get('role') == 'admin' %}
        fetchNotamLists();
        {% endif %}

        // Public View Fetcher
        async function fetchActiveNotam() {
            try {
                const response = await fetch('/api/notam/active');
                const data = await response.json();

                const ticker = document.getElementById('notam-ticker');
                const textElem = document.getElementById('notam-text');
                const module = document.getElementById('notam-module');

                if (data.active) {
                    textElem.textContent = data.text;
                    ticker.style.display = 'block';
                    module.classList.add('notam-active');
                } else {
                    ticker.style.display = 'none';
                    module.classList.remove('notam-active');
                }
            } catch (err) {
                console.error("NOTAM fetch error:", err);
            }
        }

        // Fetch NOTAM every 60 seconds
        fetchActiveNotam();
        setInterval(fetchActiveNotam, 60000);

        // Auto-Refresh VABB Data
        async function fetchLatestVABB() {
            try {
                const response = await fetch('/api/latest/VABB');
                if (!response.ok) {
                    throw new Error('Data fetch failed');
                }

                const result = await response.json();
                const data = result.data;

                // Format UTC timestamp from DB (Handle various formats)
                // FORCE UTC: 'YYYY-MM-DD HH:MM:SS' logic often defaults to local.
                // We ensure it is 'YYYY-MM-DDTHH:MM:SSZ'
                let rawTime = data.timestamp_utc;
                if (rawTime) {
                    rawTime = rawTime.replace(' ', 'T');
                    if (!rawTime.endsWith('Z')) {
                        rawTime += 'Z';
                    }
                }

                let ts = new Date(rawTime);

                // Format: HH:MM UTC
                const hours = String(ts.getUTCHours()).padStart(2, '0');
                const minutes = String(ts.getUTCMinutes()).padStart(2, '0');
                const day = String(ts.getUTCDate()).padStart(2, '0');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[ts.getUTCMonth()];

                const timeStr = `${hours}:${minutes} UTC`;
                const dateStr = `${day} ${month}`;

                const metarHTML = `
                    <div style="font-size: 0.9rem;">
                        <span style="color: #666;">Obs Time:</span> <strong>${timeStr}</strong> <span style="font-size:0.8em; color:#888;">(${dateStr})</span><br>
                        <span style="color: #666;">Wind:</span> <strong>${data.wind_direction}¬∞ / ${data.wind_speed}kt</strong><br>
                        <span style="color: #666;">Vis:</span> <strong>${data.visibility}m</strong> | 
                        <span style="color: #666;">Temp:</span> <strong>${data.temperature}¬∞C</strong>
                        <div style="margin-top:5px; font-family: monospace; background:#f0f0f0; padding:5px; border-radius:4px; font-size:0.85rem; word-break: break-all;">
                            ${data.raw_metar}
                        </div>
                    </div>
                `;

                // Update DOM
                const metarDisplay = document.querySelector('.metar-display');
                if (metarDisplay) {
                    metarDisplay.innerHTML = metarHTML;
                }
            } catch (err) {
                console.warn("VABB data not available:", err);
                const metarDisplay = document.querySelector('.metar-display');
                if (metarDisplay && metarDisplay.innerHTML.includes("Loading")) {
                    metarDisplay.innerHTML = `<p style="color:orange; font-size:0.9rem;">Latest METAR not available.<br>Retrying...</p>`;
                }
            }
        }

        // Fetch immediately and then every 60 seconds
        fetchLatestVABB();
        setInterval(fetchLatestVABB, 60000);

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Close on outside click
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }


        // SIGMET Polling
        async function updateSigmetStatus() {
            try {
                const response = await fetch('/api/sigmet/status');
                if (!response.ok) return;

                const data = await response.json();
                const container = document.getElementById('sigmet-content');

                if (!container) return;

                // Keep the button, update the text above it
                // We reconstruct the inner HTML to ensure clean state

                let statusHtml = '';
                let statusColor = '#666';
                let cardBorder = '';

                if (data.is_active) {
                    statusColor = '#dc3545'; // Red for warning
                    statusHtml = `
                        <div style="background: #ffe6e6; border: 1px solid #dc3545; padding: 10px; border-radius: 4px; width: 100%; margin-bottom: 5px;">
                            <strong style="color: #dc3545; font-size: 1rem;">‚ö†Ô∏è ACTIVE SIGMET</strong>
                            <div style="margin-top: 5px; font-size: 0.9rem; color: #333;">
                                <strong>${data.phenomenon || 'Hazard'}</strong><br>
                                <span style="font-size: 0.85rem;">Valid: ${data.valid_from || 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                } else {
                    statusColor = '#28a745'; // Green for good
                    statusHtml = `
                        <div style="color: #28a745; font-weight: 500; font-size: 1rem; margin-bottom: 5px;">
                             No Active SIGMET
                        </div>
                        <div style="color: #777; font-size: 0.85rem;">Mumbai FIR (VABF)</div>
                    `;
                }

                // Helper function to format UTC time from string
                const lastChecked = data.last_checked ? new Date(data.last_checked + 'Z').toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZone: 'UTC' }) : '--:--';

                container.innerHTML = `
                    ${statusHtml}
                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 5px;">Last checked: ${lastChecked} UTC</div>
                    <a href="https://aviationweather.gov/gfa/#sigmet" target="_blank" class="view-data-btn"
                        style="padding: 8px 20px; font-size: 0.95rem; margin-top: 5px;">
                        Display SIGMET ‚Üó
                    </a>
                `;

            } catch (e) {
                console.error("Error fetching SIGMET status:", e);
            }
        }

        // Initial call and periodic update
        updateSigmetStatus();
        setInterval(updateSigmetStatus, 60000); // Check every minute (backend updates every 5 min)

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
            } else {
                menu.classList.add('show');
            }
        }

        // --- DYNAMIC BUTTON LOGIC ---

        function openAddButtonModal(section) {
            document.getElementById('btn-section').value = section;
            document.getElementById('addButtonModal').style.display = 'flex';

            // Reset fields
            document.getElementById('add-button-form').reset();
            // Default to link
            toggleBtnInputs();
        }

        function toggleBtnInputs() {
            const type = document.getElementById('btn-type-select').value;
            const urlGroup = document.getElementById('btn-url-group');
            const fileGroup = document.getElementById('btn-file-group');
            const urlInput = document.getElementById('btn-url-input');
            const fileInput = document.getElementById('btn-file-input');

            if (type === 'link') {
                urlGroup.style.display = 'block';
                fileGroup.style.display = 'none';
                urlInput.setAttribute('required', 'required');
                fileInput.removeAttribute('required');
            } else {
                urlGroup.style.display = 'none';
                fileGroup.style.display = 'block';
                urlInput.removeAttribute('required');
                fileInput.setAttribute('required', 'required');
            }
        }

        async function submitAddButton(event) {
            event.preventDefault();
            const form = document.getElementById('add-button-form');
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/buttons/add', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    alert('Error adding button: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Network error adding button');
            }
        }

        // Injected Dynamic Buttons Data
        const dynamicButtons = {{ dynamic_buttons | tojson }};

        // ... existing functions ...

        function openDeleteButtonModal(section) {
            document.getElementById('del-btn-section').value = section;
            const select = document.getElementById('delete-btn-select');
            select.innerHTML = ''; // Clear existing

            const buttons = dynamicButtons[section] || [];

            if (buttons.length === 0) {
                const opt = document.createElement('option');
                opt.text = "No buttons directly in this section";
                opt.disabled = true;
                opt.selected = true;
                select.add(opt);
                // Disable submit?
            } else {
                buttons.forEach(btn => {
                    const opt = document.createElement('option');
                    opt.value = btn.id;
                    opt.text = btn.label;
                    select.add(opt);
                });
            }

            document.getElementById('deleteButtonModal').style.display = 'flex';
        }

        async function submitDeleteButton(event) {
            event.preventDefault();
            const select = document.getElementById('delete-btn-select');
            const btnId = select.value;

            if (!btnId || isNaN(btnId)) {
                alert("Please select a valid button.");
                return;
            }

            if (!confirm("Confirm deletion of this button?")) return;

            try {
                const response = await fetch(`/api/buttons/delete/${btnId}`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error deleting: ' + res.error);
                }
            } catch (e) {
                console.error(e);
                alert('Network error deleting button');
            }
        }
    </script>
    <script>
        // --- LOGIN AJAX HANDLING ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.querySelector('#loginModal form');
            const errorMsg = document.getElementById('login-error-msg');

            if (loginForm) {
                const inputs = loginForm.querySelectorAll('input');
                // Clear error on input
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        errorMsg.style.display = 'none';
                        errorMsg.textContent = '';
                    });
                });

                loginForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const submitBtn = document.getElementById('login-submit-btn');
                    const originalText = submitBtn ? submitBtn.textContent : 'Login';

                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Verifying...';
                    }
                    if (errorMsg) errorMsg.style.display = 'none';

                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = data.redirect;
                            } else {
                                if (errorMsg) {
                                    errorMsg.textContent = data.error || 'Login failed';
                                    errorMsg.style.display = 'block';
                                }
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                }
                            }
                        })
                        .catch(err => {
                            console.error('Login Error:', err);
                            if (errorMsg) {
                                errorMsg.textContent = 'An error occurred. Please try again.';
                                errorMsg.style.display = 'block';
                            }
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        });
                });
            }
        });
    </script>
    <script>
        async function handleUpload(event, endpoint) {
            event.preventDefault();
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = 'Uploading...';

            try {
                const formData = new FormData(form);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Success! Reload to show new item
                    window.location.reload();
                } else {
                    alert('Upload Failed: ' + (result.message || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Upload Error:', error);
                alert('Network Error occurred.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>

</html>