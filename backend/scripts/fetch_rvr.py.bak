
import sys
import os
import time
import logging
import random
import json
from datetime import datetime
from bs4 import BeautifulSoup
from playwright.sync_api import sync_playwright
from PIL import Image, ImageDraw, ImageFont

# --- Configuration ---
RVR_URL = "http://rvrcamd.imd.gov.in:5000/live-rvr"
TARGET_STATION = "Mumbai"
TARGET_CODE = "VABB"
OUTPUT_DIR = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'static', 'rvr')
LOG_DIR = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'logs')
OUTPUT_IMAGE = os.path.join(OUTPUT_DIR, 'rvr_mumbai.png')
OUTPUT_JSON = os.path.join(OUTPUT_DIR, 'data.json')
LOG_FILE = os.path.join(LOG_DIR, 'rvr_fetch.log')

# Ensure directories exist
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs(LOG_DIR, exist_ok=True)

# Logging Setup
logging.basicConfig(
    filename=LOG_FILE,
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
console_handler = logging.StreamHandler()
console_handler.setLevel(logging.INFO)
logging.getLogger().addHandler(console_handler)

def normalize_text(text):
    """Normalize text: trim, uppercase, handle empty/dash."""
    if not text:
        return "N/A"
    t = text.strip()
    if t in ["--", "-", "", "NA"]:
        return "N/A"
    return t

def get_trend_symbol(trend_text):
    """Map trend text to symbols."""
    t = trend_text.strip().lower()
    if 'u' in t or 'up' in t or 'inc' in t: # U = Upward
        return "↑"
    if 'd' in t or 'down' in t or 'dec' in t: # D = Downward
        return "↓"
    if 'n' in t or 'no' in t: # N = No Change
        return "→"
    return trend_text # Return original if unknown

def fetch_rvr_data():
    """Fetch RVR data using Playwright."""
    data = []
    
    with sync_playwright() as p:
        try:
            logging.info("Launching browser...")
            browser = p.chromium.launch(headless=True)
            page = browser.new_page()
            
            logging.info(f"Navigating to {RVR_URL}...")
            page.goto(RVR_URL, timeout=60000)
            
            # Locate search input
            logging.info("Searching for station...")
            search_input = page.locator("input[type='search']").first
            if not search_input.is_visible():
                # Fallback selectors
                search_input = page.locator("input[placeholder*='Search']").first
            
            if search_input.is_visible():
                search_input.fill(TARGET_STATION)
                search_input.press("Enter")
                logging.info(f"Typed '{TARGET_STATION}' and pressed Enter.")
            else:
                logging.warning("Search input not found, checking if data is already visible.")

            # Wait for table to load
            logging.info("Waiting for results...")
            try:
                # Wait for a row containing VABB or Mumbai
                page.wait_for_selector("tr:has-text('VABB')", timeout=15000)
            except Exception:
                logging.warning("Timeout waiting for 'VABB'. Checking for 'Mumbai'...")
                try:
                    page.wait_for_selector("tr:has-text('Mumbai')", timeout=5000)
                except:
                    # Try clicking search button if Enter didn't work
                    logging.info("Attempting to click Search button...")
                    submit_btn = page.locator("button[type='submit']").first
                    if submit_btn.is_visible():
                        submit_btn.click()
                        page.wait_for_selector("tr:has-text('VABB')", timeout=10000)

            # Extract HTML
            content = page.content()
            soup = BeautifulSoup(content, 'html.parser')
            
            # Parse Table
            rows = soup.find_all('tr')
            logging.info(f"Found {len(rows)} rows in table.")
            
            for row in rows:
                cols = row.find_all(['td', 'th'])
                row_text = [c.get_text(strip=True) for c in cols]
                
                # Basic check for target row (adjust index based on actual table structure)
                # Looking for row that has VABB or Mumbai
                if (TARGET_CODE in str(row_text)) or (TARGET_STATION in str(row_text)):
                    logging.info(f"Found Target Row: {row_text}")
                    
                    # Assuming typical RVR table structure:
                    # [Station, Runway, TDZ, MID, END, Trend, Time, ...]
                    # We need to adapt based on actual live data structure.
                    # Since I cannot see the live site, I will implement robust extraction logic.
                    # This logic assumes the table header is NOT part of 'rows' loop usually, or we skip header.
                    
                    # Heuristic Extraction (Refine if table structure is known)
                    # Example Row: ['VABB', '27', '800', '700', '600', 'N', '12:00']
                    
                    rwy = "N/A"
                    tdz = "N/A"
                    mid = "N/A"
                    end = "N/A"
                    trend = "N/A"
                    
                    # Try to identify columns by index if safe, else heuristics
                    if len(cols) >= 6:
                        # Assuming index 1 is Runway, 2=TDZ, 3=MID, 4=END, 5=Trend (0-indexed)
                        # Adjustment required if Station Name is col 0
                        
                        # Let's try to parse specifically
                        # Check header if possible? No, simplifying.
                        
                        rwy = normalize_text(cols[1].get_text()) if len(cols) > 1 else "N/A"
                        tdz = normalize_text(cols[2].get_text()) if len(cols) > 2 else "N/A"
                        mid = normalize_text(cols[3].get_text()) if len(cols) > 3 else "N/A"
                        end = normalize_text(cols[4].get_text()) if len(cols) > 4 else "N/A"
                        trend = get_trend_symbol(cols[5].get_text()) if len(cols) > 5 else "N/A"
                        
                        # Add units if missing and looks like number
                        if tdz.isdigit(): tdz += "m"
                        if mid.isdigit(): mid += "m"
                        if end.isdigit(): end += "m"
                        
                        data.append({
                            "rwy": rwy,
                            "tdz": tdz,
                            "mid": mid,
                            "end": end,
                            "trend": trend
                        })

            browser.close()
            
        except Exception as e:
            logging.error(f"Playwright Error: {e}")
            raise e
            
    return data

def generate_image(rvr_data):
    """Generate PNG image from valid RVR data."""
    width, height = 900, 320
    bg_color = (0, 31, 63) # #001f3f Dark Blue
    text_color = (255, 255, 255) # White
    header_color = (255, 215, 0) # Gold/Yellow
    
    img = Image.new('RGB', (width, height), color=bg_color)
    d = ImageDraw.Draw(img)
    
    # Fonts - Attempt to use Arial, fallback to default
    try:
        font_header = ImageFont.truetype("arial.ttf", 36)
        font_row = ImageFont.truetype("arial.ttf", 28)
        font_small = ImageFont.truetype("arial.ttf", 16)
        font_mono = ImageFont.truetype("consola.ttf", 28) # For alignment
    except IOError:
        # Linux paths or default
        try:
             font_header = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 36)
             font_row = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 28)
             font_small = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 16)
             font_mono = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf", 28)
        except:
             font_header = ImageFont.load_default()
             font_row = ImageFont.load_default()
             font_small = ImageFont.load_default()
             font_mono = ImageFont.load_default()

    # Draw Header
    d.text((width//2, 40), f"RVR – {TARGET_STATION.upper()} ({TARGET_CODE})", fill=header_color, anchor="mm", font=font_header)
    
    # Draw Table Header
    headers = ["RWY", "TDZ", "MID", "END", "TREND"]
    col_x = [100, 250, 400, 550, 700] # X positions
    
    y = 100
    for i, h in enumerate(headers):
        d.text((col_x[i], y), h, fill=header_color, font=font_row, anchor="ms")
    
    # Draw Data Rows
    y += 50
    if not rvr_data:
        d.text((width//2, y+30), "No Data Available / Fetch Failed", fill=(200, 200, 200), anchor="mm", font=font_row)
    else:
        for row in rvr_data:
            vals = [row['rwy'], row['tdz'], row['mid'], row['end'], row['trend']]
            for i, val in enumerate(vals):
                color = text_color
                if i == 4: # Trend Color
                    if val == "↓": color = (255, 100, 100) # Red
                    elif val == "↑": color = (100, 255, 100) # Green
                
                d.text((col_x[i], y), str(val), fill=color, font=font_row, anchor="ms")
            y += 45

    # Footer
    timestamp = datetime.now().strftime("%d-%b-%Y %H:%M IST")
    d.text((width - 20, height - 20), f"Updated: {timestamp}", fill=(150, 150, 150), anchor="rs", font=font_small)
    
    # Save
    logging.info(f"Saving image to {OUTPUT_IMAGE}")
    img.save(OUTPUT_IMAGE)

def save_json(rvr_data):
    """Save RVR data to JSON file."""
    try:
        output = {
            "timestamp": datetime.now().strftime("%d-%b-%Y %H:%M"),
            "data": rvr_data
        }
        with open(OUTPUT_JSON, 'w') as f:
            json.dump(output, f, indent=4)
        logging.info(f"Saved JSON data to {OUTPUT_JSON}")
    except Exception as e:
        logging.error(f"Failed to save JSON: {e}")

def main():
    logging.info("--- RVR Fetch Started ---")
    try:
        data = fetch_rvr_data()
        if data:
            generate_image(data)
            save_json(data)
            logging.info("Success: Image and JSON generated.")
        else:
            logging.warning("No data found for Mumbai.")
            # We still generate an image saying "No Data" or keep stale? 
            # Requirements: "On failure: Do not overwrite... Exit gracefully"
            # But "No data found" might be a valid result (empty table). 
            # If fetch suceeded but empty, we might want to show that.
            # Interpreting "On failure" as Exception.
            # If no data, maybe better to verify logic. For now, if no data, we assume fetch logic issue or empty site.
            
            # For this simplified version, if data is empty but no exception, we log and exit.
            logging.info("Empty data returned. Not updating image.")
            
    except Exception as e:
        logging.error(f"Failed to fetch/generate RVR: {e}")
        # Do not overwrite image
        sys.exit(1)
        
    logging.info("--- RVR Fetch Completed ---")

if __name__ == "__main__":
    main()
